import os, requests, zipfile, json, sqlite3, telnetlib, time, hashlib, http, random, urllib, shutil


def DatabaseCreateInit(currentYear):
    DBconn = sqlite3.connect('CVE' + str(currentYear) + '_OfficialMonitor.UN')
    DBcursor = DBconn.cursor()
    DatabaseInitSQL = ["create table IF NOT EXISTS TodayCVEs(CVEID TEXT primary key not null,  \
                                                             Title TEXT,  \
                                                             Descriptions TEXT,  \
                                                             Metrics TEXT,  \
                                                             CVEReferences TEXT,  \
                                                             ProblemTypes TEXT,  \
                                                             Affected TEXT, \
                                                             UpdateTime TEXT,  \
                                                             RecordValidity INT not null \
                                                             );",
                       "create table IF NOT EXISTS OldCVEs(CVEID TEXT primary key not null,  \
                                                           Title TEXT,  \
                                                           Descriptions TEXT,  \
                                                           Metrics TEXT,  \
                                                           CVEReferences TEXT,  \
                                                           ProblemTypes TEXT,  \
                                                           Affected TEXT, \
                                                           UpdateTime TEXT,  \
                                                           RecordValidity INT not null \
                                                           );"
                       ]
    try:
        for currentExecSQL in DatabaseInitSQL:
            DBcursor.execute(currentExecSQL)
        DBconn.commit()
        print("[*]Database was ready!")
    except Exception as e:
        print("[-]Database Init Error: " + str(e))
    DBcursor.close()
    DBconn.close()


def SendmailWithTelnet(MXServer, MailFrom, MailTo, Subject, Text):
    TelnetConnect = telnetlib.Telnet()
    TelnetConnect.open(MXServer, 25)
    TelnetConnect.write(b"EHLO UnknownSecurity\r\n")
    TelnetConnect.read_until(b"250-STARTTLS\r\n", timeout=3)
    TelnetConnect.read_until(b"250-8BITMIME\r\n", timeout=3)
    TelnetConnect.read_until(b"250-SIZE 73400320\r\n", timeout=3)
    TelnetConnect.read_until(b"250 OK\r\n", timeout=3)
    Mail_From = "MAIL FROM:<" + str(MailFrom) + ">"
    TelnetConnect.write(Mail_From.encode() + b'\r\n')
    TelnetConnect.read_until(b"250 OK\r\n", timeout=3)
    Mail_To = "RCPT TO:<" + str(MailTo) + ">"
    TelnetConnect.write(Mail_To.encode() + b'\r\n')
    TelnetConnect.read_until(b"250 OK\r\n", timeout=3)
    TelnetConnect.write(b'DATA\r\n')
    TelnetConnect.read_until(b"354 End data with <CR><LF>.<CR><LF>\r\n", timeout=3)
    Mail_Data = "TO:<" + str(MailTo) + ">\r\nFROM:<" + str(MailFrom) + ">\r\nSUBJECT:" + str(
        Subject) + "\r\n\r\n" + str(Text) + "\r\n.\r\n"
    TelnetConnect.write(Mail_Data.encode())
    TelnetConnect.read_until(b"250 OK: queued as.\r\n", timeout=3)
    TelnetConnect.write(b'QUIT\r\n')
    TelnetConnect.read_until(b"221 Bye.\r\n", timeout=3)
    TelnetConnect.close()


def BaiduTranslate(currentCVE, Sentence):
    # appid = '20010520000771314'
    # secretKey = 'ONSKfCvmE50pZ5ugzppJf'
    appid = BaiduTranslate_appid
    secretKey = BaiduTranslate_secretKey

    httpClient = None
    myurl = '/api/trans/vip/fieldtranslate'

    fromLang = 'auto'
    toLang = 'zh'
    salt = random.randint(32768, 65536)
    q = Sentence
    domain = 'it'
    sign = appid + q + str(salt) + domain + secretKey
    sign = hashlib.md5(sign.encode()).hexdigest()
    myurl = myurl + '?appid=' + appid + '&q=' + urllib.parse.quote(
        q) + '&from=' + fromLang + '&to=' + toLang + '&salt=' + str(salt) + '&domain=' + domain + '&sign=' + sign
    try:
        httpClient = http.client.HTTPConnection('api.fanyi.baidu.com')
        httpClient.request('GET', myurl)

        response = httpClient.getresponse()
        result_all = response.read().decode("utf-8")
        result = json.loads(result_all)
        SentenceCN = result['trans_result'][0]['dst']
    except Exception as e:
        print("Translate Error(" + str(currentCVE) + "):" + str(e))
        SentenceCN = ""
    finally:
        if httpClient:
            httpClient.close()
    return SentenceCN


def githubProxyMode(URL, useGithubProxy):
    if str(useGithubProxy) == "1":
        GithubProxy = "https://ghproxy.com/"
        URL = GithubProxy + URL
    elif str(useGithubProxy) == "2":
        GithubProxy = "https://github.proxy.unkn0wn.cn/"
        URL = str(URL).replace("https://github.com/", GithubProxy)
    else:
        GithubProxy = ""
    return URL


def DownloadAndExtractFileToJsonLoad(URL, useGithubProxy):
    URL = githubProxyMode(URL, useGithubProxy)
    WorkDirTempPath = "CVE-Offical_Monitor_TMP"
    DownloadName = str(os.path.basename(URL))
    DownloadFilePath = WorkDirTempPath + "/" + DownloadName
    UnzipPath = WorkDirTempPath + "/" + os.path.splitext(DownloadName)[0]
    try:
        if not os.path.exists(WorkDirTempPath):
            os.mkdir(WorkDirTempPath)
    except Exception as e:
        print("[-]Temp Floader not Ready!!! : " + str(e))
    try:
        URL_Request = requests.get(URL, stream=True)
        WriteFile = open(DownloadFilePath, "wb")
        for chunk in URL_Request.iter_content(chunk_size=1024):
            if chunk:
                WriteFile.write(chunk)
                WriteFile.flush()
        WriteFile.close()
    except Exception as e:
        try:
            WriteFile.close()
        except:
            pass
        print("[-]Download Error(" + str(DownloadName) + "): " + str(e))
    try:
        with zipfile.ZipFile(DownloadFilePath, 'r') as UnzipFile:
            UnzipFile.extractall(UnzipPath)
        ExtractedFileList = os.listdir(UnzipPath + "/deltaCves")
        ExtractedFilePath = []
        for currentFile in ExtractedFileList:
            ExtractedFilePath.append(UnzipPath + "/deltaCves/" + str(currentFile))
    except Exception as e:
        print("[-]Unzip Error(" + str(DownloadName) + "): " + str(e))
    LoadAllJsonToArray = []
    try:
        for currentFile in ExtractedFilePath:
            with open(currentFile, encoding="utf-8") as f:
                data = json.load(f)
                LoadAllJsonToArray.append(data)
    except Exception as e:
        print("[-]Load (" + ExtractedFilePath + ") Something went Wrong! : " + str(e))
    try:
        os.remove(DownloadFilePath)
    except Exception as e:
        print("[-]Remove Unziped File(" + DownloadFilePath + ") Error : " + str(e))
    return LoadAllJsonToArray


def ClearTmpFloader():
    WorkDirTempPath = "CVE-Offical_Monitor_TMP"
    AllTempFloader = os.listdir(WorkDirTempPath)
    if not AllTempFloader == []:
        for currentTempFloader in AllTempFloader:
            try:
                shutil.rmtree(WorkDirTempPath + "/" + currentTempFloader)
            except Exception as e:
                print("[-]Temp dir (" + WorkDirTempPath + "/" + currentTempFloader + ") Clear Fail! : " + str(e))


def OrganizeJSONintoStandardDictionary(currentLoadedCVEJson):
    StandardDictionary = {"cveMetadata": {"cveId": ""},
                          "containers": {"cna": {"title": "",
                                                 "references": "",
                                                 "affected": "",
                                                 "descriptions": [{"value": ""}],
                                                 "problemTypes": [{"descriptions": [{"description": ""}]}],
                                                 "metrics": [{"cvssV3_1": {"baseScore": "",
                                                                           "baseSeverity": ""}
                                                              }]
                                                 }
                                         }
                          }
    try:
        StandardDictionary["cveMetadata"]["cveId"] = currentLoadedCVEJson["cveMetadata"]["cveId"]
        try:
            StandardDictionary["containers"]["cna"]["title"] = currentLoadedCVEJson["containers"]["cna"]["title"]
        except Exception as e:
            print("[-] (" + StandardDictionary["cveMetadata"]["cveId"] + ") No Title in json.")
        try:
            StandardDictionary["containers"]["cna"]["descriptions"][0]["value"] = \
                currentLoadedCVEJson["containers"]["cna"]["descriptions"][0]["value"]
        except Exception as e:
            print("[-] (" + StandardDictionary["cveMetadata"]["cveId"] + ") No Descriptions in json.")
        try:
            StandardDictionary["containers"]["cna"]["metrics"][0]["cvssV3_1"]["baseScore"] = \
                currentLoadedCVEJson["containers"]["cna"]["metrics"][0]["cvssV3_1"]["baseScore"]
        except Exception as e:
            print("[-] (" + StandardDictionary["cveMetadata"]["cveId"] + ") No cvssV3_1 baseScore in json.")
        try:
            StandardDictionary["containers"]["cna"]["metrics"][0]["cvssV3_1"]["baseSeverity"] = \
                currentLoadedCVEJson["containers"]["cna"]["metrics"][0]["cvssV3_1"]["baseSeverity"]
        except Exception as e:
            print("[-] (" + StandardDictionary["cveMetadata"]["cveId"] + ") No cvssV3_1 baseSeverity in json.")
        try:
            StandardDictionary["containers"]["cna"]["references"] = currentLoadedCVEJson["containers"]["cna"][
                "references"]
        except Exception as e:
            print("[-] (" + StandardDictionary["cveMetadata"]["cveId"] + ") No References in json.")
        try:
            StandardDictionary["containers"]["cna"]["problemTypes"][0]["descriptions"][0]["description"] = \
                currentLoadedCVEJson["containers"]["cna"]["problemTypes"][0]["descriptions"][0]["description"]
        except Exception as e:
            print("[-] (" + StandardDictionary["cveMetadata"]["cveId"] + ") No problemTypes descriptions in json.")
        try:
            StandardDictionary["containers"]["cna"]["affected"] = currentLoadedCVEJson["containers"]["cna"]["affected"]
        except Exception as e:
            print("[-] (" + StandardDictionary["cveMetadata"]["cveId"] + ") No affected in json.")
    except Exception as e:
        print("[-]Error!!! This one no CVEID in json!!! Skip.")
    return StandardDictionary


def GetGithubRelease(GithubProjectURL, GithubProjectReleaseName="latest", useGithubProxy=0):
    LastTimeCVE_delta = ""
    GithubProjectURLSplit = GithubProjectURL.rsplit("/", 100)
    GithubProjectUsername = GithubProjectURLSplit[3]
    GithubProjectProjectname = GithubProjectURLSplit[4]
    LatestReleaseInformation = requests.get(githubProxyMode(
        "https://api.github.com/repos/" + str(GithubProjectUsername) + "/" + str(
            GithubProjectProjectname) + "/releases/" + str(GithubProjectReleaseName), useGithubProxy))
    for currentReleaseNode in LatestReleaseInformation.json()["assets"]:
        if "delta_CVEs_at" in currentReleaseNode["name"]:
            LastTimeCVE_delta = currentReleaseNode["browser_download_url"]
    return LastTimeCVE_delta


def ClearLongLongAgoCVEs(currentYear, LatestCVEGithubRelease):
    WhatDayIsToday = time.mktime(time.strptime(LatestCVEGithubRelease.rsplit("/", 100)[7][4:14], "%Y-%m-%d"))
    WhatDaysWantToDelete = int(WhatDayIsToday) - 2592000
    DBconn = sqlite3.connect('CVE' + str(currentYear) + '_OfficialMonitor.UN')
    DBcursor = DBconn.cursor()
    DeleteLongLongAgoCVE = "DELETE FROM OldCVEs where CVEID=?;"
    QueryOldDatabaseCVEs = "SELECT * from OldCVEs"
    OldDatabaseCVEs = DBcursor.execute(QueryOldDatabaseCVEs).fetchall()
    for currentOldDatabaseCVE in OldDatabaseCVEs:
        if int(time.mktime(time.strptime(currentOldDatabaseCVE[7][0:10], "%Y-%m-%d"))) < WhatDaysWantToDelete:
            print("[*]Delete Long Long Ago CVE : " + currentOldDatabaseCVE[0])
            DBcursor.execute(DeleteLongLongAgoCVE, (currentOldDatabaseCVE[0],))
    DBconn.commit()
    DBcursor.close()
    DBconn.close()


def MoveYesterdayCVEtoOld(currentYear, LatestCVEGithubRelease):
    WhatDayIsToday = LatestCVEGithubRelease.rsplit("/", 100)[7][4:14]
    DBconn = sqlite3.connect('CVE' + str(currentYear) + '_OfficialMonitor.UN')
    DBcursor = DBconn.cursor()
    InsertCVEtoOLDDatabase = "INSERT INTO OldCVEs(CVEID,  \
                                                  Title,  \
                                                  Descriptions,  \
                                                  Metrics,  \
                                                  CVEReferences,  \
                                                  ProblemTypes,  \
                                                  Affected, \
                                                  UpdateTime,  \
                                                  RecordValidity \
                                                  )values (?,?,?,?,?,?,?,?,?)"
    DeleteTodayDatabaseOldCVEs = "DELETE FROM TodayCVEs where CVEID=?;"
    QueryTodayDatabaseCVEs = "SELECT * from TodayCVEs"
    TodayDatabaseCVEs = DBcursor.execute(QueryTodayDatabaseCVEs).fetchall()
    for currentTodayDatabaseCVE in TodayDatabaseCVEs:
        if not currentTodayDatabaseCVE[7][0:10] == WhatDayIsToday:
            print("[*]Move Yesterday CVE to OLD : " + str(currentTodayDatabaseCVE[0]))
            DBcursor.execute(InsertCVEtoOLDDatabase, currentTodayDatabaseCVE)
            DBcursor.execute(DeleteTodayDatabaseOldCVEs, (str(currentTodayDatabaseCVE[0]),))
    DBconn.commit()
    DBcursor.close()
    DBconn.close()


def QueryExistCVE(currentYear):
    TodayExistCVE = []
    DBconn = sqlite3.connect('CVE' + str(currentYear) + '_OfficialMonitor.UN')
    DBcursor = DBconn.cursor()
    QueryTodayDatabaseCVEs = "SELECT * from TodayCVEs"
    TodayDatabaseCVE = DBcursor.execute(QueryTodayDatabaseCVEs).fetchall()
    for currentTodayDatabaseCVE in TodayDatabaseCVE:
        TodayExistCVE.append(currentTodayDatabaseCVE[0])
    DBcursor.close()
    DBconn.close()
    return TodayExistCVE


def SaveCVEToDatabase(currentYear, LatestCVEGithubRelease, LoadedLastCVEAllJsonArray):
    DBconn = sqlite3.connect('CVE' + str(currentYear) + '_OfficialMonitor.UN')
    DBcursor = DBconn.cursor()
    InsertCVEtoDatabase = "INSERT INTO TodayCVEs(CVEID,  \
                                                 Title,  \
                                                 Descriptions,  \
                                                 Metrics,  \
                                                 CVEReferences,  \
                                                 ProblemTypes,  \
                                                 Affected, \
                                                 UpdateTime,  \
                                                 RecordValidity \
                                                 )values (?,?,?,?,?,?,?,?,?)"
    TodayExistCVE = QueryExistCVE(currentYear)
    for currentLoadedLastCVEAllJson in LoadedLastCVEAllJsonArray:
        StandardDictionary = OrganizeJSONintoStandardDictionary(currentLoadedLastCVEAllJson)
        if not StandardDictionary["cveMetadata"]["cveId"] == "":
            if not StandardDictionary["cveMetadata"]["cveId"] in TodayExistCVE:
                WhatCVEFind = str(StandardDictionary["cveMetadata"]["cveId"])
                print("[+]Find New CVE : " + WhatCVEFind)
                DBcursor.execute(InsertCVEtoDatabase, (str(StandardDictionary["cveMetadata"]["cveId"]),
                                                       str(StandardDictionary["containers"]["cna"]["title"]),
                                                       str(StandardDictionary["containers"]["cna"]["descriptions"][0][
                                                               "value"]),
                                                       str(StandardDictionary["containers"]["cna"]["metrics"][0][
                                                               "cvssV3_1"]["baseScore"]) + " " + str(
                                                           StandardDictionary["containers"]["cna"]["metrics"][0][
                                                               "cvssV3_1"]["baseSeverity"]),
                                                       str(StandardDictionary["containers"]["cna"]["references"]),
                                                       str(StandardDictionary["containers"]["cna"]["problemTypes"][0][
                                                               "descriptions"][0]["description"]),
                                                       str(StandardDictionary["containers"]["cna"]["affected"]),
                                                       str(LatestCVEGithubRelease.rsplit("/", 100)[7][4:20]),
                                                       1,
                                                       ))
                EMailText = "CVE_ID：" + WhatCVEFind + \
                            "；\r\n    漏洞中文介绍：" + BaiduTranslate(str(StandardDictionary["cveMetadata"]["cveId"]),
                                                                      str(StandardDictionary["containers"]["cna"][
                                                                              "descriptions"][0]["value"])) + \
                            "；\r\n    漏洞标题：" + str(StandardDictionary["containers"]["cna"]["title"]) + \
                            "；\r\n    漏洞介绍：" + str(
                    StandardDictionary["containers"]["cna"]["descriptions"][0]["value"]) + \
                            "；\r\n    漏洞评分：" + str(
                    StandardDictionary["containers"]["cna"]["metrics"][0]["cvssV3_1"]["baseScore"]) + " " + str(
                    StandardDictionary["containers"]["cna"]["metrics"][0]["cvssV3_1"]["baseSeverity"]) + \
                            "；\r\n    相关链接：" + str(StandardDictionary["containers"]["cna"]["references"]) + \
                            "；\r\n    漏洞类型：" + str(
                    StandardDictionary["containers"]["cna"]["problemTypes"][0]["descriptions"][0]["description"]) + \
                            "；\r\n    受影响的产品：" + str(StandardDictionary["containers"]["cna"]["affected"]) + \
                            "。\r\n    <<(https://www.cve.org/CVERecord?id=" + WhatCVEFind + ")\r\n\r\n"
                SendmailWithTelnet(MXServer_ReceiveEmail, "CVEMonitor@Unknown.Unknown", ReceiveEmail,
                                   "CVE_ID又上新啦！（" + WhatCVEFind + "） - Unknown Security", EMailText)
    DBconn.commit()
    DBcursor.close()
    DBconn.close()


def StartToMonitor(useGithubProxy=0):
    while True:
        LatestCVEGithubRelease = GetGithubRelease("https://github.com/CVEProject/cvelistV5/",
                                                  useGithubProxy=int(useGithubProxy))
        WhatYearItIsNow = int(LatestCVEGithubRelease.rsplit("/", 100)[7][4:8])
        if 2023 < WhatYearItIsNow < 2050:
            Year = WhatYearItIsNow
        else:
            Year = 2023
        DatabaseCreateInit(Year)
        LoadedLastCVEAllJsonArray = DownloadAndExtractFileToJsonLoad(LatestCVEGithubRelease,
                                                                     useGithubProxy=int(useGithubProxy))
        ClearLongLongAgoCVEs(Year, LatestCVEGithubRelease)
        MoveYesterdayCVEtoOld(Year, LatestCVEGithubRelease)
        SaveCVEToDatabase(Year, LatestCVEGithubRelease, LoadedLastCVEAllJsonArray)
        time.sleep(600)
        ClearTmpFloader()


if __name__ == "__main__":
    useGithubProxy = 0
    global BaiduTranslate_appid, BaiduTranslate_secretKey, MXServer_ReceiveEmail, ReceiveEmail
    BaiduTranslate_appid = ""
    BaiduTranslate_secretKey = ""
    MXServer_ReceiveEmail = ""
    ReceiveEmail = ""
    StartToMonitor(useGithubProxy)
